name: E2E Tests with dotenvx (Manual)

on:
  workflow_dispatch:
    inputs:
      dotenv_key:
        description: 'DOTENV_PRIVATE_KEY (optional, uses secret if not provided)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  e2e-tests-secure:
    name: End-to-End Tests (Secure)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Verify DOTENV_PRIVATE_KEY
        run: |
          DOTENV_PRIVATE_KEY="${{ inputs.DOTENV_PRIVATE_KEY || secrets.DOTENV_PRIVATE_KEY }}"
          if [ -z "$DOTENV_PRIVATE_KEY" ]; then
            echo "❌ DOTENV_PRIVATE_KEY secret is not set and no input provided"
            echo "Please set DOTENV_PRIVATE_KEY secret or provide it as input"
            exit 1
          fi
          echo "✅ DOTENV_PRIVATE_KEY is configured"

      - name: Check for .env.vault
        run: |
          if [ ! -f .env.vault ]; then
            echo "❌ .env.vault file not found in repository"
            echo "Please encrypt your .env file and commit .env.vault"
            echo "Run: bun run env:encrypt"
            exit 1
          fi
          echo "✅ .env.vault file found"

      - name: Run E2E Tests with dotenvx
        run: bun test:e2e:secure
        env:
          DOTENV_PRIVATE_KEY: ${{ inputs.DOTENV_PRIVATE_KEY || secrets.DOTENV_PRIVATE_KEY }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-secure-test-results
          path: |
            **/*.log
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## E2E Test Results 🔒 (Secure with dotenvx)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Security**: Environment variables encrypted with dotenvx" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Suite**: E2E Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Runtime**: Bun + dotenvx" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ All E2E tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some E2E tests failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Note" >> $GITHUB_STEP_SUMMARY
          echo "This workflow uses encrypted environment variables via dotenvx." >> $GITHUB_STEP_SUMMARY
          echo "The .env.vault file is committed to the repository, but credentials" >> $GITHUB_STEP_SUMMARY
          echo "are encrypted and only accessible with the DOTENV_PRIVATE_KEY." >> $GITHUB_STEP_SUMMARY
